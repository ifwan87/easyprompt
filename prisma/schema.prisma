// EasyPrompt Database Schema
// Multi-tenant provider configuration with encryption

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String    // bcrypt hashed password
  emailVerified DateTime? // Email verification timestamp
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sessions      Session[]
  providers     ProviderConfig[]
  auditLogs     AuditLog[]

  @@index([email])
  @@map("users")
}

// ============================================
// Authentication & Sessions
// ============================================

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique // SHA-256 hashed session token
  expiresAt DateTime
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

// ============================================
// Provider Configuration (ENCRYPTED)
// ============================================

model ProviderConfig {
  id           String  @id @default(cuid())
  userId       String
  providerName String // 'anthropic', 'openai', 'google', 'ollama', 'huggingface', etc.

  // ENCRYPTED API KEY (using AES-256-GCM)
  // These three fields together form the encrypted API key
  encryptedApiKey String? // Base64 encoded encrypted data
  apiKeyIv        String? // Initialization vector for API key encryption
  apiKeyAuthTag   String? // Authentication tag for verification

  // ENCRYPTED ENDPOINT (for custom URLs like Ollama)
  // These three fields together form the encrypted endpoint
  encryptedEndpoint String? // Base64 encoded encrypted endpoint URL
  endpointIv        String? // Initialization vector for endpoint encryption
  endpointAuthTag   String? // Authentication tag for verification

  // Metadata
  isEnabled   Boolean   @default(true) // Can be toggled by user
  displayName String? // User-friendly name for this config
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastUsedAt  DateTime? // Track when provider was last used

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Constraints
  @@unique([userId, providerName]) // One config per provider per user
  @@index([userId])
  @@index([providerName])
  @@index([isEnabled])
  @@map("provider_configs")
}

// ============================================
// Audit Logging & Security
// ============================================

model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  action       String // e.g., 'provider.create', 'provider.update', 'provider.delete', 'provider.use'
  entityType   String // e.g., 'ProviderConfig', 'User', 'Session'
  entityId     String? // ID of the entity being acted upon
  details      Json? // Additional context (NEVER includes sensitive data)
  ipAddress    String?
  userAgent    String?
  success      Boolean  @default(true) // Whether the action succeeded
  errorMessage String? // Error details if success = false
  createdAt    DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@index([success])
  @@map("audit_logs")
}
